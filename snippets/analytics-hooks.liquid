{%- comment -%}
  Analytics Hooks (Vendor-Agnostic)
  Emits CustomEvents for integration with GA/Meta/etc

  Usage:
    Include in theme.liquid before </body>
    {% render 'analytics-hooks' %}
{%- endcomment -%}

<script>
(function(){
  if(!{{ settings.analytics_enable_hooks | json }}) return;

  // View Item Event (PDP)
  const pdp = document.querySelector('[data-product-handle]');
  if(pdp){
    const detail = {
      handle: pdp.dataset.productHandle,
      id: pdp.dataset.productId || '',
      variant: pdp.dataset.variantId || '',
      price: pdp.dataset.productPrice || '',
      currency: {{ cart.currency.iso_code | json }}
    };
    document.dispatchEvent(new CustomEvent('danliora_view_item', {detail}));
    // Legacy GA event
    document.dispatchEvent(new CustomEvent('ga_view_item', {detail}));
  }

  // Add to Cart Events (also listen for AJAX success)
  document.addEventListener('click', e => {
    const atcMain = e.target.closest('[data-cta="atc-main"]');
    const atcSticky = e.target.closest('[data-cta="atc-sticky"]');
    const atc = atcMain || atcSticky;
    
    if(atc){
      const form = atc.closest('form') || atc.form;
      const variantInput = form?.querySelector('[name="id"]');
      const qtyInput = form?.querySelector('[name="quantity"]');
      
      const detail = {
        variant_id: variantInput?.value || '',
        quantity: qtyInput?.value || '1',
        source: atcSticky ? 'sticky' : 'main',
        currency: {{ cart.currency.iso_code | json }}
      };
      
      document.dispatchEvent(new CustomEvent('danliora_add_to_cart', {detail}));
      document.dispatchEvent(new CustomEvent('ga_add_to_cart', {detail}));
    }

    // Begin Checkout Event
    const checkout = e.target.closest('[data-cta="begin-checkout"]');
    if(checkout){
      const detail = {
        cart_total: {{ cart.total_price | money_without_currency | json }},
        currency: {{ cart.currency.iso_code | json }},
        item_count: {{ cart.item_count | json }}
      };
      document.dispatchEvent(new CustomEvent('danliora_begin_checkout', {detail}));
      document.dispatchEvent(new CustomEvent('ga_begin_checkout', {detail}));
    }
  });

  // Debug mode
  if({{ settings.analytics_debug_mode | default: false | json }}){
    ['danliora_view_item', 'danliora_add_to_cart', 'danliora_begin_checkout'].forEach(evt => {
      document.addEventListener(evt, e => {
        console.log(`[Danliora Analytics] ${evt}:`, e.detail);
      });
    });
  }
})();
</script>

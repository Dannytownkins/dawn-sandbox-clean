{% comment %} Usage:
  {% render 'smart-image', image: product.featured_image, alt: product.title, sizes: "(min-width: 990px) 540px, 100vw" %}
{% endcomment %}
{% if image %}
{% assign sizes_attr = sizes | default: "(min-width: 1200px) 1100px, (min-width: 990px) 720px, 100vw" %}
{% assign widths = "360,540,720,990,1100,1440" | split: "," %}
{% capture srcset_webp %}{% for w in widths %}{{ image | image_url: width: w, format: 'webp' }} {{ w }}w{% unless forloop.last %}, {% endunless %}{% endfor %}{% endcapture %}
{% capture srcset_fallback %}{% for w in widths %}{{ image | image_url: width: w }} {{ w }}w{% unless forloop.last %}, {% endunless %}{% endfor %}{% endcapture %}
<picture class="smart-img">
  <source type="image/webp" srcset="{{ srcset_webp }}">
  <img
    src="{{ image | image_url: width: 720 }}"
    srcset="{{ srcset_fallback }}"
    sizes="{{ sizes_attr }}"
    alt="{{ alt | default: image.alt | escape }}"
    loading="lazy"
    decoding="async"
    style="background-image:url('{{ image | image_url: width: 24 }}'); background-size: cover; background-repeat:no-repeat;"
    onload="this.classList.add('is-loaded')"
  >
</picture>
<style>
.smart-img img{opacity:0; transition:opacity .25s ease}
.smart-img img.is-loaded{opacity:1}
</style>
{% endif %}

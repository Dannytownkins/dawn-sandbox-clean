<script>
// A) Add loading="lazy" to non-hero imgs that forgot it
document.addEventListener('DOMContentLoaded', function(){
  if (!('loading' in HTMLImageElement.prototype)) return;
  document.querySelectorAll('img:not([loading])').forEach(function(img){
    if (img.getBoundingClientRect().top > 300) img.setAttribute('loading','lazy');
  });
});

// B) Prefetch next product media image when the current one comes into view
(function(){
  if (!document.body.classList.contains('template-product')) return;
  var imgs = document.querySelectorAll('.product__media img, .product-media img');
  if (!imgs.length) return;
  var io = new IntersectionObserver(function(es){
    es.forEach(function(e){
      if (!e.isIntersecting) return;
      var list = Array.prototype.slice.call(imgs);
      var i = list.indexOf(e.target);
      var next = list[i+1]; if (!next) return;
      var href = next.currentSrc || next.src; if (!href) return;
      var l = document.createElement('link'); l.rel='prefetch'; l.as='image'; l.href=href;
      document.head.appendChild(l);
    });
  }, {rootMargin:'200px 0px'});
  imgs.forEach(function(i){ io.observe(i); });
})();

// C) Hover prefetch product/collection links
(function(){
  var seen = new Set();
  function prefetch(href){
    if (!href || seen.has(href) || href.indexOf('#')>-1) return;
    var l = document.createElement('link'); l.rel='prefetch'; l.href=href; document.head.appendChild(l);
    seen.add(href);
  }
  document.addEventListener('mouseover', function(e){
    var a = e.target.closest('a'); if (!a) return;
    if (/\/products\/|\/collections\//.test(a.pathname)) prefetch(a.href);
  }, {passive:true});
})();
</script>

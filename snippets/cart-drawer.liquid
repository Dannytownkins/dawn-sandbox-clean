{% comment %}
  Mini cart drawer

  Usage:
  {% render 'cart-drawer' %}
{% endcomment %}

<div id="cart-drawer" class="cart-drawer" hidden aria-hidden="true">
  <div class="cart-drawer__panel" role="dialog" aria-modal="true" aria-label="Shopping cart">
    <div class="cart-drawer__header">
      <h2 class="cart-drawer__heading">Your Cart</h2>
      <button type="button" class="cart-drawer__close" data-close-cart aria-label="Close cart">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 5L5 15M5 5l10 10"/>
        </svg>
      </button>
    </div>

    {% render 'cart-progress' %}

    <div class="cart-drawer__body" style="padding-bottom: 180px;">
      {% if cart.item_count == 0 %}
        <div class="cart-drawer__empty">
          <p>Your cart is empty</p>
          <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary" data-close-cart>Start Shopping</a>
        </div>
      {% else %}
        <div class="cart-drawer__items">
          {% for item in cart.items %}
            <div class="cart-line" data-line-index="{{ forloop.index }}">
              {% if item.image %}
                <img
                  src="{{ item.image | image_url: width: 100 }}"
                  alt="{{ item.image.alt | escape }}"
                  width="60"
                  height="60"
                  loading="lazy"
                  class="cart-line__image"
                >
              {% endif %}
              <div class="cart-line__body">
                <a href="{{ item.url }}" class="cart-line__title">{{ item.product.title }}</a>
                {% unless item.product.has_only_default_variant %}
                  <div class="cart-line__variant">{{ item.variant.title }}</div>
                {% endunless %}
                <div class="cart-line__price">{{ item.final_line_price | money }}</div>
                <div class="cart-drawer__qty" data-line="{{ forloop.index }}">
                  <button type="button" class="qty__btn" data-qty="-1" data-line="{{ forloop.index }}" aria-label="Decrease">âˆ’</button>
                  <input class="qty__input" name="updates[{{ item.key }}]" value="{{ item.quantity }}" inputmode="numeric">
                  <button type="button" class="qty__btn" data-qty="+1" data-line="{{ forloop.index }}" aria-label="Increase">+</button>
                  <a class="cart-drawer__remove" href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity=0" aria-label="Remove">ðŸ—‘</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {% render 'cart-cross-sell' %}

        {%- comment -%} Removed duplicate card-product recommendations - already have cart-cross-sell above {%- endcomment -%}

        {%- comment -%} removed trustbar/trust-badges from cart drawer {%- endcomment -%}

        {% render 'cart-note' %}

        <div class="cart-drawer__footer-fixed">
          {% render 'discount-code-inline' %}
          <div class="cart-subtotal">
            <span>Subtotal</span>
            <span class="cart-subtotal__amount">{{ cart.total_price | money }}</span>
          </div>
          <p class="cart-drawer__note">Taxes and shipping calculated at checkout</p>
          <a href="{{ routes.cart_url }}" class="btn btn--secondary btn--full-width">View Cart</a>
          <button
            type="submit"
            name="checkout"
            form="cart-drawer-form"
            class="btn btn--primary btn--full-width"
            data-cta="begin-checkout"
          >
            Checkout
          </button>
        </div>

        <form action="{{ routes.cart_url }}" method="post" id="cart-drawer-form" novalidate>
          <input type="hidden" name="checkout">
        </form>
      {% endif %}
    </div>
  </div>
  <div class="cart-drawer__overlay" data-close-cart></div>
</div>

<style>
/* ===== CART DRAWER SCOPED STYLES ===== */
/* Dark theme base */
#cart-drawer, .cart-drawer {
  color: #fff;
  background: #0a0a0a;
}
#cart-drawer *, .cart-drawer * {
  color: inherit;
}

/* Kill white slabs: product cards transparent on dark */
#cart-drawer .card,
#cart-drawer .product-card,
#cart-drawer .collection-card,
#cart-drawer .article-card,
#cart-drawer .card-wrapper,
#cart-drawer .card__content,
#cart-drawer .card__inner,
.cart-drawer .card,
.cart-drawer .product-card,
.cart-drawer .collection-card,
.cart-drawer .article-card,
.cart-drawer .card-wrapper,
.cart-drawer .card__content,
.cart-drawer .card__inner {
  background: transparent !important;
  box-shadow: none !important;
  border: 1px solid rgba(255,255,255,0.08) !important;
  border-radius: 12px;
}

/* Titles/prices readable on dark */
#cart-drawer .price,
.cart-drawer .price { color: #fff; opacity: 0.92; }
#cart-drawer .card__title,
.cart-drawer .card__title { color: #fff; }

/* Images: contained, rounded */
#cart-drawer .card__media img,
#cart-drawer .product-card__media img,
.cart-drawer .card__media img,
.cart-drawer .product-card__media img {
  display: block;
  width: 100%;
  height: auto;
  border-radius: 10px;
  background: transparent;
}

/* Buttons: yellow fill, BLACK TEXT, black stroke */
#cart-drawer .cart-drawer__footer .button,
#cart-drawer .cart-drawer__footer .btn,
#cart-drawer .cart-drawer__footer-fixed .button,
#cart-drawer .cart-drawer__footer-fixed .btn,
#cart-drawer .cart-drawer__empty .button,
#cart-drawer .cart-drawer__empty .btn,
.cart-drawer .cart-drawer__footer .button,
.cart-drawer .cart-drawer__footer .btn,
.cart-drawer .cart-drawer__footer-fixed .button,
.cart-drawer .cart-drawer__footer-fixed .btn,
.cart-drawer .cart-drawer__empty .button,
.cart-drawer .cart-drawer__empty .btn {
  background-color: #ecd96c !important;
  border: 2px solid #000 !important;
  background-clip: border-box !important;
  border-radius: 9999px !important;
  color: #000 !important;
  font-weight: 700 !important;
  box-shadow: 0 6px 12px rgba(0,0,0,.25) !important;
}
#cart-drawer .button::before,
#cart-drawer .button::after,
#cart-drawer .btn::before,
#cart-drawer .btn::after,
.cart-drawer .button::before,
.cart-drawer .button::after,
.cart-drawer .btn::before,
.cart-drawer .btn::after {
  display: none !important;
}

/* Button alignment */
#cart-drawer .buttons,
#cart-drawer .button-row,
#cart-drawer .card__actions,
.cart-drawer .buttons,
.cart-drawer .button-row,
.cart-drawer .card__actions {
  display: flex;
  gap: .5rem;
  flex-wrap: wrap;
  justify-content: flex-start;
}

/* Hide ALL product card CTAs in drawer - we're in cart already */
#cart-drawer .card .button,
#cart-drawer .card .btn,
#cart-drawer .card__actions,
#cart-drawer .product-card .button,
#cart-drawer .product-card .btn,
#cart-drawer .xsell .btn,
.cart-drawer .card .button,
.cart-drawer .card .btn,
.cart-drawer .card__actions,
.cart-drawer .product-card .button,
.cart-drawer .product-card .btn,
.cart-drawer .xsell .btn {
  display: none !important;
}

/* Free shipping progress bar */
#cart-drawer .progress,
#cart-drawer .cart-progress__bar,
.cart-drawer .progress,
.cart-drawer .cart-progress__bar {
  background: rgba(255,255,255,.12);
  border-radius: 9999px;
  overflow: hidden;
}
#cart-drawer .progress__bar,
#cart-drawer .cart-progress__bar span,
.cart-drawer .progress__bar,
.cart-drawer .cart-progress__bar span {
  background: #ecd96c !important;
}

/* Prevent oversized white blocks in upsells */
#cart-drawer .upsell-grid .card__content,
#cart-drawer .xsell .card,
#cart-drawer .cart-drawer__recommendations,
#cart-drawer .cart-recommendations,
#cart-drawer .mini-cart-upsells,
.cart-drawer .upsell-grid .card__content,
.cart-drawer .xsell .card,
.cart-drawer .cart-drawer__recommendations,
.cart-drawer .cart-recommendations,
.cart-drawer .mini-cart-upsells {
  background: transparent !important;
}

/* Upsell grid spacing */
#cart-drawer .xsell-grid,
#cart-drawer .cart-rec-grid,
.cart-drawer .xsell-grid,
.cart-drawer .cart-rec-grid {
  gap: 12px;
  margin-top: 12px;
}

/* Typography consistency */
#cart-drawer h1,
#cart-drawer h2,
#cart-drawer h3,
#cart-drawer h4,
.cart-drawer h1,
.cart-drawer h2,
.cart-drawer h3,
.cart-drawer h4 {
  color: #fff;
}

/* Drawer content spacing */
#cart-drawer .cart-drawer__body,
.cart-drawer .cart-drawer__body {
  padding: 12px 16px;
  overflow-y: auto;
  max-height: calc(100vh - 80px);
}

/* Cart line items - remove white dividers */
#cart-drawer .cart-line,
.cart-drawer .cart-line {
  border: none !important;
  border-bottom: 1px solid rgba(255,255,255,0.08) !important;
  padding: 12px 0;
  margin: 0 !important;
}

#cart-drawer .cart-drawer__items,
.cart-drawer .cart-drawer__items {
  margin: 0 !important;
  padding: 0 !important;
}

/* Fixed footer at bottom - dark background, no white block */
#cart-drawer .cart-drawer__footer-fixed,
.cart-drawer .cart-drawer__footer-fixed {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #0a0a0a;
  padding: 16px;
  border-top: 1px solid rgba(255,255,255,0.1);
  z-index: 10;
}

/* Hide discount code section - has translation errors */
#cart-drawer .discount-inline,
.cart-drawer .discount-inline {
  display: none !important;
}

/* Remove white blocks from upsells */
#cart-drawer .xsell,
#cart-drawer .cart-upsells,
.cart-drawer .xsell,
.cart-drawer .cart-upsells {
  background: transparent !important;
  border: none !important;
  padding: 12px 0 !important;
  margin: 12px 0 !important;
}

/* Cart subtotal styling */
#cart-drawer .cart-subtotal,
.cart-drawer .cart-subtotal {
  display: flex;
  justify-content: space-between;
  font-size: 1.1rem;
  font-weight: 700;
  margin: 12px 0;
  color: #fff;
}

#cart-drawer .cart-drawer__note,
.cart-drawer .cart-drawer__note {
  font-size: 0.85rem;
  opacity: 0.7;
  margin: 8px 0 12px;
}

/* Button spacing and text visibility */
#cart-drawer .btn--full-width,
.cart-drawer .btn--full-width {
  margin: 6px 0;
  color: #000 !important;
  font-size: 1rem !important;
  font-weight: 700 !important;
  line-height: 1.5 !important;
  padding: 14px 24px !important;
}

/* Quantity controls - compact styling */
#cart-drawer .cart-drawer__qty,
.cart-drawer .cart-drawer__qty {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

#cart-drawer .qty__btn,
.cart-drawer .qty__btn {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  line-height: 1;
}

#cart-drawer .qty__input,
.cart-drawer .qty__input {
  width: 40px;
  height: 28px;
  text-align: center;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  color: #fff;
  font-size: 0.9rem;
  padding: 4px;
}

#cart-drawer .cart-drawer__remove,
.cart-drawer .cart-drawer__remove {
  font-size: 1.1rem;
  opacity: 0.7;
  margin-left: 4px;
  text-decoration: none;
}

#cart-drawer .cart-drawer__remove:hover,
.cart-drawer .cart-drawer__remove:hover {
  opacity: 1;
}
</style>

<script>
// Quantity and remove handling WITHOUT page reload
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.qty__btn');
  const removeBtn = e.target.closest('.cart-drawer__remove');
  
  if (btn) {
    e.preventDefault();
    const line = Number(btn.dataset.line);
    const delta = btn.dataset.qty === '+1' ? 1 : -1;
    const input = btn.parentElement.querySelector('.qty__input');
    const currentQty = parseInt(input.value || '1', 10);
    const next = Math.max(0, currentQty + delta);

    try {
      const response = await fetch('{{ routes.cart_change_url }}', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ line, quantity: next })
      });
      
      if (response.ok) {
        // Trigger refresh without page reload
        if (window.CartDrawer && window.CartDrawer.refresh) {
          await window.CartDrawer.refresh();
        }
      }
    } catch(err) {
      console.error('Cart update failed:', err);
    }
  }
  
  if (removeBtn) {
    e.preventDefault();
    const url = removeBtn.getAttribute('href');
    try {
      await fetch(url, { method: 'POST' });
      // Trigger refresh without page reload
      if (window.CartDrawer && window.CartDrawer.refresh) {
        await window.CartDrawer.refresh();
      }
    } catch(err) {
      console.error('Remove failed:', err);
    }
  }
});
</script>
